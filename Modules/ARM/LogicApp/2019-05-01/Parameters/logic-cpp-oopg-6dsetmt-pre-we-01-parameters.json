{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"workflowName": {
			"value": "logic-cpp-oopg-6dsetmt-pre-we-01"
		},
		"workflowLocation": {
			"value": "westeurope"
		},
		"workflowSchema": {
			"value": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#"
		},
		"workflowActions": {
			"value": {
				"Create_blob_(V2)": {
					"inputs": {
						"body": "@body('Get_blob_content_using_path_(V2)')",
						"headers": {
							"ReadFileMetadataFromServer": true
						},
						"host": {
							"connection": {
								"name": "@parameters('$connections')['azureblob_2']['connectionId']"
							}
						},
						"method": "post",
						"path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent('stcppappsapimtprewe01'))}/files",
						"queries": {
							"folderPath": "/pgw-settlement",
							"name": "@body('Parse_JSON')?['Name']",
							"queryParametersSingleEncoded": true
						}
					},
					"runAfter": {
						"Get_blob_content_using_path_(V2)": [
							"Succeeded"
						]
					},
					"runtimeConfiguration": {
						"contentTransfer": {
							"transferMode": "Chunked"
						}
					},
					"type": "ApiConnection"
				},
				"Get_blob_content_using_path_(V2)": {
					"inputs": {
						"host": {
							"connection": {
								"name": "@parameters('$connections')['azureblob']['connectionId']"
							}
						},
						"method": "get",
						"path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent('stcppoopgmtprewe01'))}/GetFileContentByPath",
						"queries": {
							"inferContentType": true,
							"path": "@body('Parse_JSON')?['Path']",
							"queryParametersSingleEncoded": true
						}
					},
					"runAfter": {
						"Parse_JSON": [
							"Succeeded"
						]
					},
					"type": "ApiConnection"
				},
				"Initialize_ContainerName": {
					"inputs": {
						"variables": [
							{
								"name": "ContainerName",
								"type": "string",
								"value": "pgw-settlement/"
							}
						]
					},
					"runAfter": {
						"Initialize_StorageAccountName": [
							"Succeeded"
						]
					},
					"type": "InitializeVariable"
				},
				"Initialize_FilePath": {
					"inputs": {
						"variables": [
							{
								"name": "FilePath",
								"type": "object",
								"value": {
									"file": "@concat('https://',variables('StorageAccountName'),'.blob.core.windows.net/',variables('ContainerName'),body('Parse_JSON')?['Name'])"
								}
							}
						]
					},
					"runAfter": {
						"Initialize_ContainerName": [
							"Succeeded"
						]
					},
					"type": "InitializeVariable"
				},
				"Initialize_StorageAccountName": {
					"inputs": {
						"variables": [
							{
								"name": "StorageAccountName",
								"type": "string",
								"value": "stcppappsapimtprewe01"
							}
						]
					},
					"runAfter": {
						"Create_blob_(V2)": [
							"Succeeded"
						]
					},
					"type": "InitializeVariable"
				},
				"Parse_JSON": {
					"inputs": {
						"content": "@triggerBody()",
						"schema": {
							"properties": {
								"DisplayName": {
									"type": "string"
								},
								"ETag": {
									"type": "string"
								},
								"FileLocator": {
									"type": "string"
								},
								"Id": {
									"type": "string"
								},
								"IsFolder": {
									"type": "boolean"
								},
								"LastModified": {
									"type": "string"
								},
								"LastModifiedBy": {},
								"MediaType": {
									"type": "string"
								},
								"Name": {
									"type": "string"
								},
								"Path": {
									"type": "string"
								},
								"Size": {
									"type": "integer"
								}
							},
							"type": "object"
						}
					},
					"runAfter": {},
					"type": "ParseJson"
				},
				"Publish_Event": {
					"inputs": {
						"body": [
							{
								"data": "@variables('FilePath')",
								"eventTime": "@{utcNow('yyyy-MM-dd')}",
								"eventType": "pgw-settlement",
								"id": "@{guid()}",
								"subject": "pgw",
								"topic": "meteringdata"
							}
						],
						"host": {
							"connection": {
								"name": "@parameters('$connections')['azureeventgridpublish']['connectionId']"
							}
						},
						"method": "post",
						"path": "/eventGrid/api/events"
					},
					"runAfter": {
						"Initialize_FilePath": [
							"Succeeded"
						]
					},
					"type": "ApiConnection"
				}
			}
		},
		"workflowTriggers": {
			"value": {
				"When_a_blob_is_added_or_modified_(properties_only)_(V2)": {
					"inputs": {
						"host": {
							"connection": {
								"name": "@parameters('$connections')['azureblob']['connectionId']"
							}
						},
						"method": "get",
						"path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent('stcppoopgmtprewe01'))}/triggers/batch/onupdatedfile",
						"queries": {
							"checkBothCreatedAndModifiedDateTime": false,
							"folderId": "JTJmcGd3LXNldHRsZW1lbnQ=",
							"maxFileCount": 1
						}
					},
					"metadata": {
						"JTJmcGd3JTJmcGd3LXNldHRsZW1lbnQlMmY=": "/pgw/pgw-settlement/",
						"JTJmcGd3LW1ldGVyaW5n": "/pgw-metering",
						"JTJmcGd3LXNldHRsZW1lbnQ=": "/pgw-settlement"
					},
					"recurrence": {
						"frequency": "Minute",
						"interval": 1
					},
					"splitOn": "@triggerBody()",
					"type": "ApiConnection"
				}
			}
		},
		"workflowParameters": {
			"value": {
				"$connections": {
					"defaultValue": {},
					"type": "Object"
				}
			}
		},
		"diagnosticLogsRetentionInDays": {
		  "value": 365
		},
		"diagnosticStorageAccountId": {
		  "value": "/subscriptions/d8c326fb-f8b4-4854-a2af-dd55e86f6117/resourceGroups/rg-cph-pltf-mon-prd-we-01/providers/Microsoft.Storage/storageAccounts/stcphpltfdiagprdwe01"
		},
		"workspaceId": {
		  "value": "/subscriptions/d8c326fb-f8b4-4854-a2af-dd55e86f6117/resourceGroups/rg-cph-pltf-mon-prd-we-01/providers/Microsoft.OperationalInsights/workspaces/log-cph-pltf-prd-we-01"
		},
		"eventHubAuthorizationRuleId": {
		  "value": "/subscriptions/8964f3c1-44f5-4094-80eb-4334845bdfb1/resourceGroups/rg-cpp-apps-mon-pre-we-01/providers/Microsoft.EventHub/namespaces/evhns-cpp-apps-mon-pre-we-01/authorizationrules/RootManageSharedAccessKey"
		},
		"eventHubName": {
		  "value": "evh-cpp-apps-mon-pre-we-01"
		},
		"tags": {
			"value": {
				"Environment": "Pre-Production"
			}
		},
		"connectionParameters": {
			"value": {
				"$connections": {
					"value": {
						"azureblob": {
							"connectionId": "/subscriptions/8964f3c1-44f5-4094-80eb-4334845bdfb1/resourceGroups/rg-cpp-oopg-mtr-pre-we-01/providers/Microsoft.Web/connections/apicon-cpp-oopg-mtr-pre-we-01",
							"connectionName": "apicon-cpp-oopg-mtr-pre-we-01",
							"id": "/subscriptions/8964f3c1-44f5-4094-80eb-4334845bdfb1/providers/Microsoft.Web/locations/westeurope/managedApis/azureblob"
						},
						"azureblob_2": {
							"connectionId": "/subscriptions/8964f3c1-44f5-4094-80eb-4334845bdfb1/resourceGroups/rg-cpp-apps-int-pre-we-01/providers/Microsoft.Web/connections/apicon-cpp-apps-apimtst-pre-we-01",
							"connectionName": "apicon-cpp-apps-apimtst-pre-we-01",
							"id": "/subscriptions/8964f3c1-44f5-4094-80eb-4334845bdfb1/providers/Microsoft.Web/locations/westeurope/managedApis/azureblob"
						},
						"azureeventgridpublish": {
							"connectionId": "/subscriptions/8964f3c1-44f5-4094-80eb-4334845bdfb1/resourceGroups/rg-cpp-apps-int-pre-we-01/providers/Microsoft.Web/connections/apicon-cpp-apps-integd-pre-we-01",
							"connectionName": "apicon-cpp-apps-integd-pre-we-01",
							"id": "/subscriptions/8964f3c1-44f5-4094-80eb-4334845bdfb1/providers/Microsoft.Web/locations/westeurope/managedApis/azureeventgridpublish"
						}
					}
				}
			}
		}
	}
}