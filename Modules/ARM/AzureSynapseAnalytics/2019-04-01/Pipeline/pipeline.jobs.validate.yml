parameters:
  templateFile: $(modulePath)/deploy.json
  parametersFile: $(modulePath)/Parameters/parameters.json

jobs:
  - job: ValidateModule
    displayName: Validate Module
    pool:
      name: $(poolName)
      #vmImage: $(vmImage)      
    variables:
      - template: pipeline.variables.yml
    steps:
      - task: PowerShell@2
        displayName: Test Module $(moduleName) (Pester)
        inputs:
          targetType: inline
          script: |
            Install-Module -Name Pester -RequiredVersion 5.0.2 -Force -ErrorAction Stop


            $PesterSettings  = @{
              Script       = "$(System.DefaultWorkingDirectory)/$(modulePath)/Tests/*.tests.ps1"
              OutputFile   = "$(Agent.WorkFolder)/testsresult.xml"
              OutputFormat = "NUnitXml"
              EnableExit   = $true
              Verbose      = $true
            }

            Invoke-Pester @PesterSettings
          pwsh: true

      - task: PublishTestResults@2
        displayName: Publish Test Results
        inputs:
          testResultsFormat: NUnit
          testResultsFiles: $(Agent.WorkFolder)/testsresult.xml